<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Rust Server Stats — Tabs</title>
<style>
  :root{--bg:#0b0f16;--card:#111827;--muted:#9ca3af;--text:#e5e7eb;--acc:#14b8a6;--border:#1f2937;--shadow:0 10px 24px rgba(0,0,0,.35)}
  *{box-sizing:border-box}
  body{margin:0;background:var(--bg);color:var(--text);font-family:ui-sans-serif,system-ui,Segoe UI,Roboto,Helvetica,Arial,sans-serif}
  header{padding:24px;display:flex;align-items:center;gap:12px;justify-content:space-between;flex-wrap:wrap}
  h1{margin:0;font-weight:800;letter-spacing:.5px}
  a{color:#93c5fd;text-decoration:none}
  a:hover{text-decoration:underline}
  .pill{display:inline-block;background:#09121f;border:1px solid var(--border);padding:6px 10px;border-radius:999px;color:#cbd5e1;font-size:.9rem;text-decoration:none}
  .toolbar{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
  .toolbar select,.toolbar input{padding:6px 10px;border-radius:10px;border:1px solid var(--border);background:#0d1624;color:var(--text);outline:none}
  .wrap{padding:0 24px 40px;max-width:1300px;margin:0 auto}

  /* Tabs */
  .tabs{display:flex;gap:8px;flex-wrap:wrap;margin-bottom:16px}
  .tab-btn{padding:8px 12px;border:1px solid var(--border);background:#0d1624;color:var(--text);border-radius:10px;cursor:pointer}
  .tab-btn.active{background:var(--acc);border-color:transparent;color:#0b0f16;font-weight:700}
  .panel{display:none}
  .panel.active{display:block}

  /* Cards/sections */
  .section{background:var(--card);border:1px solid var(--border);border-radius:16px;box-shadow:var(--shadow);padding:14px}
  .section h2{margin:6px 6px 0 6px;font-weight:800}
  .hint{margin:6px;color:var(--muted);font-size:.9rem}

  table{width:100%;border-collapse:collapse;margin-top:12px}
  th,td{padding:12px 14px;border-top:1px solid var(--border);text-align:left;white-space:nowrap}
  th{color:#d1d5db;font-weight:700;user-select:none;cursor:pointer}
  th .dir{opacity:.7;font-size:.85em;margin-left:4px}
  tbody tr:hover{background:#0e1522}
</style>
</head>
<body>
  <header>
    <div>
      <h1>Rust Server Stats — Tabs <span id="status" class="pill">connecting…</span></h1>

    </div>
    <div class="toolbar">
      <label>View:
        <select id="scopeSel">
          <option value="wipe" selected>Current wipe</option>
          <option value="lifetime">Lifetime</option>
        </select>
      </label>
      <input id="searchBox" type="search" placeholder="Search player…" style="min-width:200px">
      <span id="wipeInfo" class="pill"></span>
    </div>
  </header>

  <div class="wrap">
    <!-- Tab buttons -->
    <div class="tabs" id="tabs"></div>

    <!-- Panels -->
    <div id="panels"></div>
  </div>

<script>
(() => {
  const API_BASE = '/api';
  const $ = (s, el=document) => el.querySelector(s);
  const $$ = (s, el=document) => Array.from(el.querySelectorAll(s));
  const fmt = x => (x==null||isNaN(x)) ? "0" : (Math.round((+x)*100)/100).toLocaleString();
  const km = x => fmt((+x)/1000);
  const WEAPON_KEYS = [
    "rifle.ak", "rifle.lr300", "rifle.m39", "rifle.bolt", "rifle.hmlmg", "rifle.l96", "rifle.semiauto",
    "smg.mp5", "smg.thompson", "smg.2", "pistol.python", "pistol.revolver", "pistol.semiauto", "pistol.prototype17",
    "shotgun.spas12", "shotgun.pump", "shotgun.waterpipe", "shotgun.double", "crossbow", "bow.compound", "bow.hunting",
    "lmg.m249"
  ];
  const weaponLabel = (k) => {
    const map = {
      "rifle.ak": "AK",
      "rifle.lr300": "LR-300",
      "rifle.m39": "M39",
      "rifle.bolt": "Bolt",
      "rifle.hmlmg": "HMLMG",
      "rifle.l96": "L96",
      "rifle.semiauto": "SAR",
      "smg.mp5": "MP5",
      "smg.thompson": "Thompson",
      "smg.2": "Custom SMG",
      "pistol.python": "Python",
      "pistol.revolver": "Revolver",
      "pistol.semiauto": "Semi Pistol",
      "pistol.prototype17": "P2",
      "shotgun.spas12": "Spas-12",
      "shotgun.pump": "Pump",
      "shotgun.waterpipe": "Waterpipe",
      "shotgun.double": "Double Barrel",
      "crossbow": "Crossbow",
      "bow.compound": "Compound Bow",
      "bow.hunting": "Hunting Bow",
      "lmg.m249": "M249",
    };
    return map[k] || k;
  };
  const buildWeaponKeys = (prefix) => WEAPON_KEYS.map(w => `${prefix}${w}`);
  const fmtDuration = (seconds) => {
    const total = Math.max(0, Math.floor(Number(seconds) || 0));
    const d = Math.floor(total / 86400);
    const h = Math.floor((total % 86400) / 3600);
    const m = Math.floor((total % 3600) / 60);
    const s = total % 60;
    if (d > 0) return `${d}d ${h}h ${m}m ${s}s`;
    if (h > 0) return `${h}h ${m}m ${s}s`;
    return `${m}m ${s}s`;
  };
  const preferredWeapon = (counters, prefix) => {
    let best = null;
    for (const [k, v] of Object.entries(counters || {})){
      if (!k.startsWith(prefix)) continue;
      const count = Number(v) || 0;
      if (count <= 0) continue;
      const w = k.slice(prefix.length);
      if (!best || count > best.count) best = { w, count };
    }
    return best ? weaponLabel(best.w) : "-";
  };

  // Scope + search
  let SCOPE = localStorage.getItem("scope") || "wipe";
  let FILTER = (localStorage.getItem("filter") || "").toLowerCase();
  const scopeSel = $("#scopeSel");
  const searchBox = $("#searchBox");
  scopeSel.value = SCOPE;
  searchBox.value = localStorage.getItem("filter") || "";

  scopeSel.addEventListener("change", ()=>{ SCOPE=scopeSel.value; localStorage.setItem("scope",SCOPE); loadAll(); });
  searchBox.addEventListener("input", ()=>{ FILTER=(searchBox.value||"").toLowerCase(); localStorage.setItem("filter",searchBox.value||""); draw(); });

  async function jget(path){
    const url = API_BASE + path + (path.includes("?") ? "&" : "?") + "scope=" + encodeURIComponent(SCOPE);
    const r = await fetch(url, { cache: "no-store" });
    if(!r.ok) throw new Error(`${r.status} ${r.statusText}`);
    return r.json();
  }
  async function lb(key){ try { return await jget(`/leaderboard/${encodeURIComponent(key)}`); } catch(e){ console.error("lb", key, e); return []; } }

  // ---- Tabs spec (label, hint, keys & headers) ----
  // NOTE: for “to be added” items, these keys are placeholders — UI will show 0 until plugin/backend sends them.
  const TABS = [
    {
      id: "general",
      label: "General",
      hint: "Distance travelled & playtime.",
      headers: [
        {label:"Player", k:"last_name", fmt: v => v},
        {label:"Distance (km)", k:"distance.m", fmt: (v)=>km(v)},
        {label:"Playtime", k:"playtime.seconds", fmt: (v)=>fmtDuration(v)}, // show as DD HH MM SS
        {label:"Craft Time", k:"craft.time.seconds", fmt: (v)=>fmtDuration(v)}, // actual elapsed craft time
      ],
      keys: ["distance.m", "playtime.seconds", "craft.time.seconds"]
    },
    {
      id: "gathering",
      label: "Gathering",
      hint: "Totals gathered.",
      headers: [
        {label:"Player", k:"last_name", fmt: v => v},
        {label:"Wood", k:"gather.wood"},
        {label:"Stone", k:"gather.stone"},
        {label:"Metal Ore", k:"gather.metal"},
        {label:"HQM Ore", k:"gather.hq"},
        {label:"Sulfur Ore", k:"gather.sulfur"},
        {label:"Barrels", k:"barrels.destroyed"},
      ],
      keys: ["gather.wood","gather.stone","gather.metal","gather.hq","gather.sulfur","barrels.destroyed"]
    },
    {
      id: "pvp",
      label: "PvP",
      hint: "Kills, deaths, arrows, bullets (non-explosive), longest kill, preferred weapon.",
      headers: [
        {label:"Player", k:"last_name", fmt: v => v},
        {label:"Kills", k:"kills.player"},
        {label:"Deaths", k:"deaths"},
        {label:"Arrows", k:"bullets.arrow"},
        {label:"Bullets", k:"bullets.total_non_explosive"}, // computed client-side (see draw)
        {label:"Longest Kill (m)", k:"highest_range_kill.m"},
        {label:"Preferred Weapon", k:"preferred.weapon.pvp", fmt: v => v},
        {label:"Accuracy %", k:"pvp.accuracy", fmt: v => v},
        {label:"Headshot %", k:"pvp.hsrate", fmt: v => v},
      ],
      // We fetch bullet subkeys and compute non-explosive total on the client
      keys: ["kills.player","deaths","bullets.arrow","bullets.pistol","bullets.rifle","bullets.shotgun","bullets.nail","highest_range_kill.m","bullets.explosive","pvp.shots.fired","pvp.shots.hit","pvp.shots.head", ...buildWeaponKeys("kills.weapon.pvp.")]
    },
    {
      id: "explosives",
      label: "Explosives",
      hint: "Thrown/used explosives by type.",
      headers: [
        {label:"Player", k:"last_name", fmt: v => v},
        {label:"C4", k:"c4.thrown"},
        {label:"Explosive Bullets", k:"bullets.explosive"},      // to be added
        {label:"Satchels", k:"satchel.thrown"},                   // to be added
        {label:"Grenades (F1)", k:"grenade.f1.thrown"},           // to be added
        {label:"Beancans", k:"grenade.beancan.thrown"},           // to be added
        {label:"Rockets", k:"rockets.basic"},
        {label:"HV Rockets", k:"rockets.hv"},
        {label:"Incendiary Rockets", k:"rockets.incendiary"},
      ],
      keys: ["c4.thrown","bullets.explosive","satchel.thrown","grenade.f1.thrown","grenade.beancan.thrown","rockets.basic","rockets.hv","rockets.incendiary"]
    },
    {
  id: "events",
  label: "Events",
  hint: "Major PvE/combat events.",
      headers: [
        {label:"Player", k:"last_name", fmt: v => v},
        {label:"Bradley", k:"bradley.destroyed"},
        {label:"Heli", k:"heli.destroyed"},
        {label:"Hacked Crates", k:"hackedcrates.collected"},
        {label:"Airdrops", k:"airdrops.collected"},
        {label:"Preferred Weapon", k:"preferred.weapon.events", fmt: v => v},
      ],
  keys: ["bradley.destroyed","heli.destroyed","hackedcrates.collected","airdrops.collected", ...buildWeaponKeys("kills.weapon.events.")]
},

    {
      id: "scientists",
      label: "Scientists",
      hint: "Kills per NPC group + preferred weapon.",
      headers: [
        {label:"Player", k:"last_name", fmt: v => v},
        {label:"Normal Scientist", k:"kills.scientist.normal"}, // to be added
        {label:"Cargo Scientist", k:"kills.scientist.cargo"},   // to be added
        {label:"Oil Rig Scientist", k:"kills.scientist.oilrig"},// to be added
        {label:"Excavator Scientist", k:"kills.scientist.excavator"},
        {label:"Ch47 Scientist", k:"kills.scientist.ch47"},
        {label:"Tunnel Dweller", k:"kills.tunneldweller"},
        {label:"Preferred Weapon", k:"preferred.weapon.scientists", fmt: v => v},
      ],
      keys: ["kills.scientist.normal","kills.scientist.cargo","kills.scientist.oilrig","kills.scientist.excavator","kills.scientist.ch47","kills.tunneldweller", ...buildWeaponKeys("kills.weapon.scientist.")]
    },
    {
      id: "animals",
      label: "Animals",
      hint: "Animal kills (some entries are for modded servers).",
      headers: [
        {label:"Player", k:"last_name", fmt: v => v},
        {label:"Chicken", k:"kills.animal.chicken"},
        {label:"Boar", k:"kills.animal.boar"},
        {label:"Horse", k:"kills.animal.horse"},
        {label:"Deer", k:"kills.animal.stag"},
        {label:"Wolf", k:"kills.animal.wolf"},
        {label:"Bear", k:"kills.animal.bear"},
        {label:"Tiger", k:"kills.animal.tiger"},         /* modded */
        {label:"Panther", k:"kills.animal.panther"},     /* modded */
        {label:"Crocodile", k:"kills.animal.crocodile"}, /* modded */
        {label:"Snake", k:"kills.animal.snake"},         /* modded */
      ],
      keys: ["kills.animal.chicken","kills.animal.boar","kills.animal.horse","kills.animal.stag","kills.animal.wolf","kills.animal.bear","kills.animal.tiger","kills.animal.panther","kills.animal.crocodile","kills.animal.snake"]
    },
    {
      id: "farming",
      label: "Farming",
      hint: "Harvests/collects (to be added).",
      headers: [
        {label:"Player", k:"last_name", fmt: v => v},
        {label:"Corn", k:"farm.corn"},       // to be added
        {label:"Pumpkin", k:"farm.pumpkin"}, // to be added
        {label:"Potato", k:"farm.potato"},   // to be added
        {label:"Berries", k:"farm.berries"}, // to be added
        {label:"Hemp", k:"farm.hemp"},       // to be added
      ],
      keys: ["farm.corn","farm.pumpkin","farm.potato","farm.berries","farm.hemp"]
    },
    {
      id: "gambling",
      label: "Gambling",
      hint: "Casino outcomes (spent & profit).",
      headers: [
        {label:"Player", k:"last_name", fmt: v => v},
        {label:"Blackjack Spent", k:"casino.blackjack.spent"},
        {label:"Blackjack Profit", k:"casino.blackjack.profit"},
        {label:"Slots Spent", k:"casino.slots.spent"},
        {label:"Slots Profit", k:"casino.slots.profit"},
        {label:"Poker Spent", k:"casino.poker.spent"},
        {label:"Poker Profit", k:"casino.poker.profit"},
        {label:"Wheel Spent", k:"casino.bigwheel.spent"},
        {label:"Wheel Profit", k:"casino.bigwheel.profit"},
      ],
      keys: [
        "casino.blackjack.spent","casino.blackjack.profit",
        "casino.slots.spent","casino.slots.profit",
        "casino.poker.spent","casino.poker.profit",
        "casino.bigwheel.spent","casino.bigwheel.profit"
      ]
    }
  ];

  // Build tabs UI
  const tabsBar = $("#tabs");
  const panels = $("#panels");
  for (const t of TABS){
    const b = document.createElement("button");
    b.className = "tab-btn";
    b.textContent = t.label;
    b.dataset.tab = t.id;
    tabsBar.appendChild(b);

    const p = document.createElement("div");
    p.className = "panel";
    p.id = "panel-"+t.id;
    p.innerHTML = `
      <div class="section">
        <h2>${t.label}</h2>
        <div class="hint">${t.hint}</div>
        <table data-tab="${t.id}">
          <thead><tr>
            ${t.headers.map(h => `<th data-k="${h.k}" class="sortable">${h.label} <span class="dir"></span></th>`).join("")}
          </tr></thead>
          <tbody></tbody>
        </table>
      </div>`;
    panels.appendChild(p);
  }
  // Activate first tab by default
  const activate = (id) => {
    $$(".tab-btn").forEach(x=>x.classList.toggle("active", x.dataset.tab===id));
    $$(".panel").forEach(x=>x.classList.toggle("active", x.id==="panel-"+id));
  };
  activate(TABS[0].id);
  tabsBar.addEventListener("click", (e)=>{
    const b = e.target.closest(".tab-btn"); if(!b) return;
    activate(b.dataset.tab);
    draw(); // redraw sort arrows when switching
  });

  // Sorting state per tab
  const sortStates = {};
  for (const t of TABS){
    sortStates[t.id] = { key: t.headers[1]?.k || "last_name", dir: "desc" };
  }

  function attachSorting(){
    for (const t of TABS){
      const tbl = $(`table[data-tab="${t.id}"]`);
      $$("thead th", tbl).forEach(th=>{
        th.addEventListener("click", ()=>{
          const k = th.dataset.k; if(!k) return;
          const st = sortStates[t.id];
          st.dir = (st.key===k && st.dir==="desc") ? "asc" : (st.key===k && st.dir==="asc" ? "desc" : "desc");
          st.key = k;
          draw();
        });
      });
    }
  }

  // Fetch + merge helper
  async function mergeKeys(keys){
  const map = new Map(); // key by string user_id to avoid weird falsy coercion

  for (const key of keys){
    const rows = await lb(key);
    for (const r of rows){
      const uidKey = String(r.user_id);           // stable map key
      const nameFromApi = (r.last_name ?? "").toString().trim();

      if (!map.has(uidKey)){
        map.set(uidKey, {
          user_id: r.user_id,                      // keep original type
          last_name: nameFromApi || uidKey,        // fallback to uid text, NOT "0"
          counters: {}
        });
      } else {
        // if we have a better name later, adopt it
        const obj = map.get(uidKey);
        if (nameFromApi && (!obj.last_name || obj.last_name === "0" || obj.last_name === String(obj.user_id))){
          obj.last_name = nameFromApi;
        }
      }

      // assign counter
      map.get(uidKey).counters[key] = Number(r.value || 0);
    }
  }

  return Array.from(map.values());
}


  let DATA = {}; // per tab rows
  async function loadAll(){
    $("#status").textContent = "loading…";
    try{
      // header pill
      try{
        const meta = await jget(`/health`);
        const started = meta.wipe_started || 0;
        const el = $("#wipeInfo");
        if (SCOPE === "wipe" && started){
          const d = new Date(started * 1000);
          el.textContent = `Wipe since ${d.toLocaleDateString()} ${d.toLocaleTimeString()}`;
          el.style.display = "inline-block";
        } else {
          el.textContent = SCOPE === "lifetime" ? "Lifetime totals" : "";
          el.style.display = SCOPE === "lifetime" ? "inline-block" : "none";
        }
      } catch {}

      // load each tab's rows
      for (const t of TABS){
        DATA[t.id] = await mergeKeys(t.keys);
      }

      $("#status").textContent = "live";
      $("#status").style.color = "#10b981";
      draw();
    }catch(e){
      console.error(e);
      $("#status").textContent = "error";
      $("#status").style.color = "#ef4444";
    }
  }

  function renderTableForTab(tab){
    const t = TABS.find(x=>x.id===tab);
    const tbl = $(`table[data-tab="${tab}"]`);
    const tbody = $("tbody", tbl); tbody.innerHTML = "";
    const headers = t.headers;
    let rows = DATA[tab] || [];

    // filter by player name
    let arr = FILTER
      ? rows.filter(r => (r.last_name||String(r.user_id)).toLowerCase().includes(FILTER))
      : rows;

    // compute bullets.total_non_explosive for PvP
    if (tab === "pvp"){
      arr = arr.map(r=>{
        const c = r.counters || {};
        // Non-explosive = pistol + rifle + shotgun + nail, minus any explicit 'bullets.explosive' if present
        const base = (c["bullets.pistol"]||0) + (c["bullets.rifle"]||0) + (c["bullets.shotgun"]||0) + (c["bullets.nail"]||0);
        const ex = (c["bullets.explosive"]||0);
        const fired = Number(c["pvp.shots.fired"] || 0);
        const hit = Number(c["pvp.shots.hit"] || 0);
        const head = Number(c["pvp.shots.head"] || 0);
        const acc = fired > 0 ? ((hit / fired) * 100).toFixed(1) + "%" : "0%";
        const hs = hit > 0 ? ((head / hit) * 100).toFixed(1) + "%" : "0%";
        return {
          ...r,
          "bullets.total_non_explosive": Math.max(0, base - ex),
          "preferred.weapon.pvp": preferredWeapon(c, "kills.weapon.pvp."),
          "pvp.accuracy": acc,
          "pvp.hsrate": hs
        };
      });
    }
    // preferred weapons per tab using specific prefixes
    if (tab === "scientists"){
      arr = arr.map(r=>{
        const c = r.counters || {};
        return { ...r, "preferred.weapon.scientists": preferredWeapon(c, "kills.weapon.scientist.") };
      });
    }
    if (tab === "events"){
      arr = arr.map(r=>{
        const c = r.counters || {};
        return { ...r, "preferred.weapon.events": preferredWeapon(c, "kills.weapon.events.") };
      });
    }

    const st = sortStates[tab];
    const k = st.key, dir = st.dir;
    arr.sort((a,b)=>{
      const av = (k==="last_name") ? (a.last_name||"") : (a.counters?.[k] ?? a[k] ?? 0);
      const bv = (k==="last_name") ? (b.last_name||"") : (b.counters?.[k] ?? b[k] ?? 0);
      if (typeof av === "string" || typeof bv === "string"){
        return dir==="asc" ? String(av).localeCompare(String(bv)) : String(bv).localeCompare(String(av));
      }
      return dir==="asc" ? (av-bv) : (bv-av);
    });

    for (const r of arr){
      const tr = document.createElement("tr");
      for (const col of headers){
        const td = document.createElement("td");
        const val = (col.k==="last_name")
          ? (r.last_name || r.user_id)
          : (r[col.k] ?? r.counters?.[col.k] ?? 0);
        td.textContent = col.fmt ? col.fmt(val) : fmt(val);
        tr.appendChild(td);
      }
      tbody.appendChild(tr);
    }

    // header arrows
    $$("thead th", tbl).forEach(th=>{
      const kk = th.dataset.k;
      const span = $(".dir", th);
      span.textContent = (kk===k) ? (dir==="asc" ? "▲" : "▼") : "";
    });

    if (arr.length === 0){
      const tr = document.createElement("tr");
      const td = document.createElement("td");
      td.colSpan = headers.length;
      td.textContent = "No players match your search.";
      td.style.color = "var(--muted)";
      tr.appendChild(td);
      tbody.appendChild(tr);
    }
  }

  function draw(){
    for (const t of TABS){
      renderTableForTab(t.id);
    }
  }

  attachSorting();
  loadAll();
  setInterval(loadAll, 10000);
})();
</script>
</body>
</html>
